on local
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"

If you still have password SSH access, do this:
ssh-copy-id username@YOUR_SERVER_IP


Example:
ssh-copy-id deploy@123.45.67.89


This automatically appends your key to:
~/.ssh/authorized_keys


on the VPS.

or

cat ~/.ssh/id_rsa.pub
mkdir -p ~/.ssh
nano ~/.ssh/authorized_keys
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys

5ï¸âƒ£ (Recommended) Secure SSH on the VPS

Edit SSH config:

sudo nano /etc/ssh/sshd_config


Set / confirm:

PubkeyAuthentication yes
PasswordAuthentication no
PermitRootLogin no


Restart SSH:

sudo systemctl restart ssh

===========

optional auto config on ssh:
nano ~/.ssh/config

Host myvps
  HostName SERVER_IP
  User deploy
  Port 1371
  IdentityFile ~/.ssh/id_ed25519
==============

Switch to ED25519 (modern, faster, recommended)
On your Mac
ssh-keygen -t ed25519 -C "your_email@example.com"

============
Lock SSH to a custom port

sudo nano /etc/ssh/sshd_config

Port 1371
PubkeyAuthentication yes
PasswordAuthentication no
PermitRootLogin no

=========


sudo ufw allow 1371/tcp
sudo ufw --force enable
sudo ufw reload
sudo ufw status
sudo systemctl restart ssh

===========

for github CI


On VPS
su - deploy
mkdir -p ~/.ssh
nano ~/.ssh/authorized_keys


Paste GitHub Actions public key (from repo secrets).

chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys

Recommended CI deploy user permissions
sudo visudo


Add:

deploy ALL=(ALL) NOPASSWD: /bin/systemctl, /usr/bin/pm2
==================
Create an SSH key on the VPS (important)

Log into VPS as deploy:

ssh myvps


Generate a key without passphrase (best for servers):

ssh-keygen -t ed25519 -C "deploy@yourserver"


Press Enter for everything
â†’ creates:

~/.ssh/id_ed25519
~/.ssh/id_ed25519.pub

2ï¸âƒ£ Add VPS public key to GitHub

On VPS:

cat ~/.ssh/id_ed25519.pub


Copy output.

GitHub â†’ Settings â†’ SSH and GPG keys

New SSH key

Title: my-vps-deploy

Paste the key

Save
===========================
If repo is NOT cloned yet:
git clone git@github.com:username/repo-name.git

If repo already exists (using HTTPS):
cd your-project
git remote -v


Change it:

git remote set-url origin git@github.com:username/repo-name.git


Verify:

git remote -v
======================

deploy static

sudo mkdir -p /var/www/example.com
sudo chown -R deploy:deploy /var/www

rm -rf /var/www/hipfoam.com/*
mv out/* /var/www/hipfoam.com/

or

rm -rf /www/hipfoam.com/* && mv out/* /www/hipfoam.com/ && sudo systemctl reload nginx

or for zero down time
mv out /www/hipfoam.com_new
mv /www/hipfoam.com /www/hipfoam.com_old
mv /www/hipfoam.com_new /www/hipfoam.com
rm -rf /www/hipfoam.com_old

then


sudo systemctl reload nginx
sudo chown -R deploy:deploy /www/hipfoam.com
sudo chmod -R 755 /www/hipfoam.com



sudo nano /etc/nginx/sites-available/example.com

server {
    listen 80;
    listen [::]:80;
    server_name example.com www.example.com;

    root /www/example.com;
    index index.html;

    # Gzip (important for Next.js)
    gzip on;
    gzip_types
        text/plain
        text/css
        application/json
        application/javascript
        text/xml
        application/xml
        application/xml+rss
        image/svg+xml;
    gzip_min_length 1024;

    # Cache static assets aggressively
    location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico|woff|woff2)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # Next.js _next files
    location /_next/ {
        expires 30d;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # SPA fallback (important for routing)
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
}

sudo ln -s /etc/nginx/sites-available/example.com \
           /etc/nginx/sites-enabled/

 sudo rm /etc/nginx/sites-enabled/default

sudo nginx -t
sudo systemctl reload nginx

sudo chown -R deploy:deploy /www/example.com
sudo chmod -R 755 /www

==========
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d example.com -d www.example.com
sudo certbot renew --dry-run
=======




bonus:

deploy.sh:
#!/usr/bin/env bash
set -e

APP_NAME="hipfoam.com"
APP_DIR="$HOME/hipfoam/hipfoam-website"
WWW_ROOT="/www"
CURRENT="$WWW_ROOT/$APP_NAME"
NEXT="$WWW_ROOT/${APP_NAME}_next"
OLD="$WWW_ROOT/${APP_NAME}_old"

echo "ğŸš€ Deploy started..."

cd "$APP_DIR"

echo "ğŸ“¥ Pulling latest code..."
git pull origin main

echo "ğŸ“¦ Installing dependencies..."
npm ci

echo "ğŸ— Building Next.js..."
npm run build

echo "ğŸ§¹ Preparing new release..."
rm -rf "$NEXT"
mv out "$NEXT"

echo "ğŸ” Atomic swap..."
mv "$CURRENT" "$OLD" || true
mv "$NEXT" "$CURRENT"

echo "ğŸ§½ Cleaning old release..."
rm -rf "$OLD"

echo "ğŸ”„ Reloading Nginx..."
sudo systemctl reload nginx

echo "âœ… Deploy finished successfully!"

chmod +x ~/deploy.sh
./deploy.sh


===============
multi site nginx config:
/www
 â”œâ”€â”€ hipfoam.com
 â”œâ”€â”€ site2.com
 â””â”€â”€ site3.com

/etc/nginx
 â”œâ”€â”€ snippets/
 â”‚    â”œâ”€â”€ security.conf
 â”‚    â””â”€â”€ gzip.conf
 â”œâ”€â”€ sites-available/
 â”‚    â”œâ”€â”€ hipfoam.com
 â”‚    â””â”€â”€ site2.com
 â””â”€â”€ sites-enabled/

/etc/nginx/snippets/gzip.conf

gzip on;
gzip_comp_level 6;
gzip_min_length 1024;
gzip_types
  text/plain
  text/css
  application/json
  application/javascript
  text/xml
  application/xml
  application/xml+rss
  image/svg+xml;


/etc/nginx/snippets/security.conf
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;

# HSTS (enable AFTER HTTPS)
# add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

# CSP (safe default for static Next.js)
add_header Content-Security-Policy "
  default-src 'self';
  img-src 'self' data: https:;
  font-src 'self' data:;
  style-src 'self' 'unsafe-inline';
  script-src 'self' 'unsafe-inline';
" always;

/etc/nginx/sites-available/hipfoam.com

server {
    listen 80;
    listen [::]:80;
    server_name hipfoam.com www.hipfoam.com;

    root /www/hipfoam.com;
    index index.html;

    include snippets/gzip.conf;
    include snippets/security.conf;

    # Next.js build assets
    location /_next/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # Static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico|woff2?)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # SPA routing support
    location / {
        try_files $uri $uri/ /index.html;
    }
}

sudo ln -s /etc/nginx/sites-available/hipfoam.com /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx

===================


for github CI

Awesome â€” this is now full production DevOps level ğŸ˜„
Iâ€™ll give you battle-tested configs, minimal magic, all copy-pasteable.

1ï¸âƒ£ ğŸ¤– GitHub Actions auto-deploy (SSH â†’ VPS)
A) GitHub repo â†’ Secrets

Add these repo secrets:

Name	Value
VPS_HOST	your.server.ip
VPS_USER	deploy
VPS_PORT	1371
VPS_SSH_KEY	private key of deploy (from VPS or local)

âš ï¸ Use a dedicated deploy key, NOT your personal one.

B) GitHub Actions workflow

ğŸ“ .github/workflows/deploy.yml

name: Deploy to VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: SSH Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_PORT }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ~/hipfoam/hipfoam-website
            ./deploy.sh


âœ… Push to main â†’ auto deploy
âœ… No passwords
âœ… Fully secure

2ï¸âƒ£ ğŸ” Rollback command (instant)

Because we used atomic deploy, rollback is trivial.

mv /www/hipfoam.com /www/hipfoam.com_broken
mv /www/hipfoam.com_old /www/hipfoam.com
sudo systemctl reload nginx


Want a script?

nano ~/rollback.sh

#!/usr/bin/env bash
set -e
mv /www/hipfoam.com /www/hipfoam.com_failed
mv /www/hipfoam.com_old /www/hipfoam.com
sudo systemctl reload nginx
echo "ğŸ” Rollback completed"

chmod +x ~/rollback.sh

3ï¸âƒ£ ğŸ”¥ Fail2Ban (SSH & Nginx protection)

Install:

sudo apt install fail2ban

SSH jail
sudo nano /etc/fail2ban/jail.local

[sshd]
enabled = true
port = 1371
maxretry = 5
findtime = 10m
bantime = 1h


Restart:

sudo systemctl restart fail2ban


Check:

sudo fail2ban-client status sshd

4ï¸âƒ£ ğŸ§± Rate-limit + bot protection (Nginx)
A) Define limits (global)

ğŸ“ /etc/nginx/nginx.conf
Inside http {}:

limit_req_zone $binary_remote_addr zone=req_limit:10m rate=10r/s;
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

B) Apply per site

ğŸ“ /etc/nginx/sites-available/hipfoam.com

server {
    ...

    limit_req zone=req_limit burst=20 nodelay;
    limit_conn conn_limit 20;

    location = /robots.txt {
        allow all;
        log_not_found off;
        access_log off;
    }

    location ~* /(wp-admin|wp-login|xmlrpc|env|git) {
        deny all;
        return 444;
    }
}


âœ” Blocks scanners
âœ” Stops brute-force bots
âœ” No impact on real users

Reload:

sudo systemctl reload nginx

5ï¸âƒ£ ğŸ“Š Access logs per site (clean & useful)
A) Per-site logs
access_log /var/log/nginx/hipfoam.access.log;
error_log  /var/log/nginx/hipfoam.error.log warn;


Add inside server block.

B) Log rotation (automatic)

Check:

sudo nano /etc/logrotate.d/nginx


Default is fine, but ensure:

weekly
rotate 12
compress
delaycompress
notifempty

C) Live monitoring
tail -f /var/log/nginx/hipfoam.access.log


Or install GoAccess (optional):

sudo apt install goaccess
goaccess /var/log/nginx/hipfoam.access.log

âœ… Final Production Checklist

âœ” GitHub auto-deploy
âœ” Atomic deploy + rollback
âœ” SSH brute-force protection
âœ” Bot & rate-limit blocking
âœ” Per-site logs
âœ” Scales to 50+ sites
âœ” Ready for investors & clients

Want next?

ğŸŒ Cloudflare (free WAF + CDN)

ğŸ§  Multi-environment (staging/prod)

ğŸš€ Blue-green deploy

ğŸ“¦ Monorepo deploy strategy

ğŸ” Secrets management

Just say it ğŸ˜

what is Blue-green deploy

Great question â€” this is one of those concepts that sounds fancy but is actually very simple, especially for static sites ğŸ‘

ğŸŒˆ What is Blueâ€“Green Deployment?

Blueâ€“Green deploy means:

You keep two complete versions of your app live on the server
and you instantly switch traffic between them.

No partial updates.
No broken state.
Near zero downtime.

ğŸ§  The idea (very simple)
BLUE   â†’ current live version (users see this)
GREEN  â†’ new version being deployed & tested


When GREEN is ready:

ğŸ‘‰ switch traffic
ğŸ‘‰ GREEN becomes live
ğŸ‘‰ BLUE becomes backup (rollback target)

ğŸ” Visual example
/www
 â”œâ”€â”€ hipfoam.com_blue   â† live
 â”œâ”€â”€ hipfoam.com_green  â† new build
 â””â”€â”€ hipfoam.com â†’ symlink (points to blue or green)


Nginx always serves:

/www/hipfoam.com


But that path is just a symlink.

ğŸš€ Deploy flow (step by step)

Users are on BLUE

You build into GREEN

You test GREEN

You switch symlink in 1 command

Traffic moves instantly

BLUE stays as rollback

ğŸ” Why itâ€™s powerful
Problem	Solved
Downtime	âŒ
Half-built site	âŒ
Broken cache	âŒ
Fast rollback	âœ…
Safe deploy	âœ…
âš¡ Switch is instant
ln -sfn /www/hipfoam.com_green /www/hipfoam.com
nginx -s reload


This happens in milliseconds.

ğŸ§ª Example for Next.js static export
Folder layout
/www
 â”œâ”€â”€ hipfoam.com_blue
 â”œâ”€â”€ hipfoam.com_green
 â””â”€â”€ hipfoam.com -> hipfoam.com_blue

Build new version
npm run build
mv out /www/hipfoam.com_green


Test locally:

cd /www/hipfoam.com_green
python3 -m http.server

Switch live
ln -sfn /www/hipfoam.com_green /www/hipfoam.com
sudo systemctl reload nginx

ğŸ”™ Rollback (1 command)
ln -sfn /www/hipfoam.com_blue /www/hipfoam.com
sudo systemctl reload nginx

ğŸ†š Blueâ€“Green vs Atomic rename
Method	Rollback	Safety	Used by
Atomic rename	Medium	High	Small setups
Blueâ€“Green	Instant	Very High	Big companies
In-place copy	âŒ	âŒ	Avoid
ğŸ§± When should YOU use it?

Use Blueâ€“Green if:

You deploy often

You want instant rollback

You host many static sites

You want zero risk deploys

For your setup (many Next.js static sites) â†’ perfect fit ğŸ‘Œ

ğŸ§  Mental model (remember this)

â€œI never touch what users are seeing
I only switch pointers.â€

Thatâ€™s Blueâ€“Green.

If you want next, I can:

ğŸ”§ Convert your deploy script to Blueâ€“Green

ğŸ¤– Integrate it with GitHub Actions

ğŸ” Add health checks before switching

ğŸ“Š Add deploy logging

Just say the word ğŸš€







server {
    server_name hipfoam.com www.hipfoam.com;

    root /www/hipfoam.com;
    index index.html;

    # Gzip (important for Next.js)
    gzip on;
    gzip_types
        text/plain
        text/css
        application/json
        application/javascript
        text/xml
        application/xml
        application/xml+rss
        image/svg+xml;
    gzip_min_length 1024;

    # Cache static assets aggressively
    location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico|woff|woff2)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # Next.js _next files
    location /_next/ {
        expires 30d;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # SPA fallback (important for routing)
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    listen [::]:443 ssl ipv6only=on; # managed by Certbot
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/hipfoam.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/hipfoam.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot


}
server {
    if ($host = www.hipfoam.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    if ($host = hipfoam.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    listen 80;
    listen [::]:80;
    server_name hipfoam.com www.hipfoam.com;
    return 404; # managed by Certbot




}